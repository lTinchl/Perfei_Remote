#include "OLED_UI_Driver.h"

/*
???????[?????]
?????????????????????????????????????????
????oled????????????????????????????????????????
????????????????
*/


/**
 * @brief ????????????????????20ms??????
 * @param ?
 * @return ?
 */
void Timer_Init(void)
{
	/*????*/
	RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM4, ENABLE);			//??TIM4???
	
	/*?????*/
	TIM_InternalClockConfig(TIM4);		//??TIM4??????????????TIM????????
	
	/*???????*/
	TIM_TimeBaseInitTypeDef TIM_TimeBaseInitStructure;				//???????
	TIM_TimeBaseInitStructure.TIM_ClockDivision = TIM_CKD_DIV1;		//?????????????????????????????????
	TIM_TimeBaseInitStructure.TIM_CounterMode = TIM_CounterMode_Up;	//????????????
	TIM_TimeBaseInitStructure.TIM_Period = 200 - 1;				//??????ARR??
	TIM_TimeBaseInitStructure.TIM_Prescaler = 7200 - 1;				//??????PSC??
	TIM_TimeBaseInitStructure.TIM_RepetitionCounter = 0;			//???????????????
	TIM_TimeBaseInit(TIM4, &TIM_TimeBaseInitStructure);				//????????TIM_TimeBaseInit???TIM4?????	
	
	/*??????*/
	TIM_ClearFlag(TIM4, TIM_FLAG_Update);						//??????????
																//TIM_TimeBaseInit??????????????
																//?????????????????????????
																//???????????????????
	
	TIM_ITConfig(TIM4, TIM_IT_Update, ENABLE);					//??TIM4?????
	
	/*NVIC????*/
	NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);				//??NVIC???2
																//?????????0~3?????????0~3
																//?????????????????
																//???????????????main????while????
																//?????????????????????????????
	
	/*NVIC??*/
	NVIC_InitTypeDef NVIC_InitStructure;						//???????
	NVIC_InitStructure.NVIC_IRQChannel = TIM4_IRQn;				//????NVIC?TIM4?
	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;				//??NVIC????
	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 2;	//??NVIC?????????2
	NVIC_InitStructure.NVIC_IRQChannelSubPriority = 1;			//??NVIC?????????1
	NVIC_Init(&NVIC_InitStructure);								//????????NVIC_Init???NVIC??
	
	/*TIM??*/
	TIM_Cmd(TIM4, ENABLE);			//??TIM4????????
}

/**
 * @brief ???????????????GPIO
 * @param ?
 * @note GPIO??????????????????????????????????????
 * @return ?
 */
void Key_Init(void)
{
	GPIO_InitTypeDef GPIO_InitStructure;
    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB, ENABLE);
    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_12 | GPIO_Pin_15;
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IPU;  
    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
    GPIO_Init(GPIOB, &GPIO_InitStructure);

    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOC, ENABLE);
    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_13;
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IPU;  
    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
    GPIO_Init(GPIOC, &GPIO_InitStructure);

    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE);
    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_8;
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IPU;  
    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
    GPIO_Init(GPIOA, &GPIO_InitStructure);
}



/**
 * @brief ?????????????1????????
 * @param ?
 * @return ?
 */
void Encoder_Init(void)
{
	
	
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_TIM1, ENABLE);
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE);
	
	
	GPIO_InitTypeDef GPIO_InitStructure;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IPU;
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_8 | GPIO_Pin_9;
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_Init(GPIOA, &GPIO_InitStructure);
		
	TIM_TimeBaseInitTypeDef TIM_TimeBaseInitStructure;
	TIM_TimeBaseInitStructure.TIM_ClockDivision = TIM_CKD_DIV1;
	TIM_TimeBaseInitStructure.TIM_CounterMode = TIM_CounterMode_Up;
	TIM_TimeBaseInitStructure.TIM_Period = 65536 - 1;		//ARR
	TIM_TimeBaseInitStructure.TIM_Prescaler = 1 - 1;		//PSC
	TIM_TimeBaseInitStructure.TIM_RepetitionCounter = 0;
	TIM_TimeBaseInit(TIM1, &TIM_TimeBaseInitStructure);
	
	TIM_ICInitTypeDef TIM_ICInitStructure;
	TIM_ICStructInit(&TIM_ICInitStructure);
	TIM_ICInitStructure.TIM_Channel = TIM_Channel_1;
	TIM_ICInitStructure.TIM_ICFilter = 0xF;
	TIM_ICInit(TIM1, &TIM_ICInitStructure);
	TIM_ICInitStructure.TIM_Channel = TIM_Channel_2;
	TIM_ICInitStructure.TIM_ICFilter = 0xF;
	TIM_ICInit(TIM1, &TIM_ICInitStructure);
	
	TIM_EncoderInterfaceConfig(TIM1, TIM_EncoderMode_TI12, TIM_ICPolarity_Rising, TIM_ICPolarity_Rising);
	
	TIM_Cmd(TIM1, ENABLE);
	
	TIM_SetCounter(TIM1, 0);
}


/**
 * @brief ???????
 * @param ?
 * @return ?
 */
void Encoder_Enable(void)
{
	TIM_Cmd(TIM1, ENABLE);
}

/**
 * @brief ???????
 * @param ?
 * @return ?
 */
void Encoder_Disable(void)
{
	TIM_Cmd(TIM1, DISABLE);
}

/**
 * @brief ??????????????????
 * 
 * @details ??????????TIM1?????????????????????
 *          ???????????????????????????????
 *          ??????????????????????????????
 * 
 * @note   ??????????????????????????
 * 
 * @return int16_t ????????????
 */
int16_t Encoder_Get(void)
{
    // ?????????????????4?????
    static int32_t encoderAccumulator = 0;
    
    // ??????????
    int16_t temp = TIM_GetCounter(TIM1);
    
    // ?????????????????
    TIM_SetCounter(TIM1, 0);
    
    // ?????????????
    encoderAccumulator += temp;
    
    // ??????????????????????
    int16_t result = encoderAccumulator / 4;
    
    // ????4??????????
    encoderAccumulator %= 4;
    
    // ?????????
    return result;
}



/**
  * @brief  ?????
  * @param  xus ????????0~233015
  * @retval ?
  */
void Delay_us(uint32_t xus)
{
	SysTick->LOAD = 72 * xus;				//????????
	SysTick->VAL = 0x00;					//???????
	SysTick->CTRL = 0x00000005;				//??????HCLK??????
	while(!(SysTick->CTRL & 0x00010000));	//?????0
	SysTick->CTRL = 0x00000004;				//?????
}

/**
  * @brief  ?????
  * @param  xms ????????0~4294967295
  * @retval ?
  */
void Delay_ms(uint32_t xms)
{
	while(xms--)
	{
		Delay_us(1000);
	}
}
 
/**
  * @brief  ????
  * @param  xs ????????0~4294967295
  * @retval ?
  */
void Delay_s(uint32_t xs)
{
	while(xs--)
	{
		Delay_ms(1000);
	}
} 


